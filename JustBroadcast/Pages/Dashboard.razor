@page "/"
@using DevExpress.Blazor
@using JustBroadcast.Models
@using JustBroadcast.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject IAuthService AuthService
@inject IConfiguration Configuration
@inject HttpClient HttpClient

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Just Broadcast Dashboard</h1>
        <p>Monitor your playout operations</p>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <DxLoadingPanel Visible="true" Text="Loading dashboard..." />
        </div>
    }
    else if (dashboardData != null)
    {
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon playout-icon">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Playouts</div>
                    <div class="stat-value">@dashboardData.PlayoutStats.Total</div>
                    <div class="stat-detail">@dashboardData.PlayoutStats.Running running, @dashboardData.PlayoutStats.Offline offline</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon channel-icon">
                    <i class="fas fa-tv"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Channels</div>
                    <div class="stat-value">@dashboardData.ChannelStats.Total</div>
                    <div class="stat-detail">@dashboardData.ChannelStats.Assigned channels assigned</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon user-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Users</div>
                    <div class="stat-value">@dashboardData.UserStats.Total</div>
                    <div class="stat-detail">@dashboardData.UserStats.Online user online</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon media-icon">
                    <i class="fas fa-photo-video"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Media Assets</div>
                    <div class="stat-value">@dashboardData.MediaAssetStats.Total.ToString("N0")</div>
                    <div class="stat-detail">+@dashboardData.MediaAssetStats.AddedThisWeek this week</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Alerts</div>
                    <div class="stat-value">@dashboardData.AlertStats.Total</div>
                    <div class="stat-detail">@dashboardData.AlertStats.RequireAttention require attention</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Active Playouts -->
            <div class="panel active-playouts-panel">
                <div class="panel-header">
                    <h2>Active Playouts</h2>
                </div>
                <DxGrid Data="@dashboardData.ActivePlayouts"
                        CssClass="playouts-grid"
                        ShowFilterRow="false"
                        ShowGroupPanel="false"
                        AllowSort ="false"
                        ColumnResizeMode="GridColumnResizeMode.Disabled">
                    <Columns>
                        <DxGridDataColumn FieldName="PlayoutName" Caption="Playout Name" Width="25%" SortIndex="-1" AllowSort="false" />
                        <DxGridDataColumn FieldName="ChannelName" Caption="Channel Name" Width="25%" SortIndex="-1" AllowSort="false" />
                        <DxGridDataColumn FieldName="Status" Caption="Status" Width="20%" SortIndex="-1" AllowSort="false">
                            <CellDisplayTemplate>
                                @{
                                    var playout = (ActivePlayout)context.DataItem;
                                    var statusClass = playout.Status.ToLower();
                                }
                                <span class="status-badge status-@statusClass">
                                    @playout.Status
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="Playing" Caption="Playing" Width="20%" SortIndex="-1" AllowSort="false">
                            <CellDisplayTemplate>
                                @{
                                    var playout = (ActivePlayout)context.DataItem;
                                    var playingClass = playout.Playing.ToLower();
                                }
                                <span class="playing-badge playing-@playingClass">
                                    @if (playout.Playing == "playing")
                                    {
                                        <i class="fas fa-play"></i>
                                    }
                                    else if (playout.Playing == "scheduled")
                                    {
                                        <i class="fas fa-clock"></i>
                                    }
                                    else if (playout.Playing == "error")
                                    {
                                        <i class="fas fa-exclamation-circle"></i>
                                    }
                                    @playout.Playing
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="Spare" Caption="Spare" Width="10%" TextAlignment="GridTextAlignment.Center" SortIndex="-1" AllowSort="false">
                            <CellDisplayTemplate>
                                @{
                                    var playout = (ActivePlayout)context.DataItem;
                                }
                                @if (playout.Spare)
                                {
                                    <i class="fas fa-check spare-check"></i>
                                }
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                    </Columns>
                </DxGrid>
            </div>

            <!-- Error Feed -->
            <div class="panel error-feed-panel">
                <div class="panel-header">
                    <h2>Error Feed</h2>
                </div>
                <div class="error-list">
                    @foreach (var error in dashboardData.ErrorFeed)
                    {
                        <div class="error-item error-@error.Type">
                            <div class="error-icon">
                                @if (error.Type == "error")
                                {
                                    <i class="fas fa-circle"></i>
                                }
                                else if (error.Type == "warning")
                                {
                                    <i class="fas fa-exclamation-triangle"></i>
                                }
                            </div>
                            <div class="error-content">
                                <div class="error-message">@error.Message</div>
                                <div class="error-time">@error.TimeAgo</div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- System Resources -->
            <div class="panel system-resources-panel">
                <div class="panel-header">
                    <h2>System Resources</h2>
                </div>
                <div class="resources-content">
                    <div class="resource-stats">
                        <div class="resource-item">
                            <div class="resource-label">CPU</div>
                            <div class="resource-value">@dashboardData.SystemResources.CpuUsage%</div>
                        </div>
                        <div class="resource-item">
                            <div class="resource-label">GPU</div>
                            <div class="resource-value">@dashboardData.SystemResources.GpuUsage%</div>
                        </div>
                        <div class="resource-item">
                            <div class="resource-label">RAM</div>
                            <div class="resource-value">@dashboardData.SystemResources.RamUsage%</div>
                        </div>
                    </div>
                    <div class="cpu-chart">
                        <div class="chart-label">CPU</div>
                        <DxChart Data="@dashboardData.SystemResources.CpuHistory" Width="100%" Height="200px">
                            <DxChartLineSeries ArgumentField="@((CpuDataPoint v) => v.Time)"
                                               ValueField="@((CpuDataPoint v) => v.Value)"
                                               Name="CPU Usage">
                                <DxChartSeriesPoint HoverMode="ChartSeriesPointHoverMode.Point" />
                            </DxChartLineSeries>
                            <DxChartArgumentAxis>
                                <DxChartAxisLabel Format="ChartElementFormat.ShortTime" />
                            </DxChartArgumentAxis>
                            <DxChartLegend Visible="false" />
                            <DxChartTooltip Enabled="true" Position="RelativePosition.Outside">
                                <div class="chart-tooltip">
                                    <div>@context.Point.Argument</div>
                                    <div><strong>@context.Point.Value%</strong></div>
                                </div>
                            </DxChartTooltip>
                        </DxChart>
                    </div>
                </div>
            </div>

            <!-- Error Frequency Chart -->
            <div class="panel error-frequency-panel">
                <div class="panel-header">
                    <h2>Error Frequency (last 7 days)</h2>
                </div>
                <DxChart Data="@errorFrequencyData" Width="100%">
                    <DxChartBarSeries ArgumentField="@((ErrorFrequencyItem v) => v.Day)"
                                      ValueField="@((ErrorFrequencyItem v) => v.Count)"
                                      Name="Errors">
                        <DxChartSeriesPoint HoverMode="ChartSeriesPointHoverMode.Point" />
                    </DxChartBarSeries>
                    <DxChartLegend Visible="false" />
                    <DxChartTooltip Enabled="true" Position="RelativePosition.Outside">
                        <div class="chart-tooltip">
                            <div>@context.Point.Argument</div>
                            <div><strong>@context.Point.Value errors</strong></div>
                        </div>
                    </DxChartTooltip>
                </DxChart>
                <div class="chart-footer">
                    <div class="recommended-actions">
                        <div class="recommended-label">RECOMMENDED ACTIONS</div>
                        <div class="recommended-item">Ffmpeg update required</div>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div class="panel alerts-panel">
                <div class="panel-header">
                    <h2>ALERTS</h2>
                </div>
                <div class="alerts-list">
                    @foreach (var alert in dashboardData.Alerts)
                    {
                        <div class="alert-item alert-@alert.Type">
                            <div class="alert-icon">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-message">@alert.Message</div>
                                <div class="alert-time">@alert.TimeAgo</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>


