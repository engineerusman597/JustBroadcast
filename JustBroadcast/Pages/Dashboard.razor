@page "/"
@using DevExpress.Blazor
@using JustBroadcast.Models
@using JustBroadcast.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Blazored.LocalStorage
@attribute [Authorize]
@inject IAuthService AuthService
@inject IConfiguration Configuration
@inject HttpClient HttpClient
@inject ISignalRService SignalRService
@inject ILocalStorageService LocalStorage

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Just Broadcast Dashboard</h1>
        <p>Monitor your playout operations</p>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <DxLoadingPanel Visible="true" Text="Loading dashboard..." />
        </div>
    }
    else if (dashboardData != null)
    {
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon playout-icon">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Playouts</div>
                    <div class="stat-value">@dashboardData.PlayoutStats.Total</div>
                    <div class="stat-detail">@GetPlayoutStatusText()</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon channel-icon">
                    <i class="fas fa-tv"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Channels</div>
                    <div class="stat-value">@dashboardData.ChannelStats.Total</div>
                    <div class="stat-detail">@GetChannelStatusText()</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon user-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Users</div>
                    <div class="stat-value">@dashboardData.UserStats.Total</div>
                    <div class="stat-detail">@dashboardData.UserStats.Online user online</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon media-icon">
                    <i class="fas fa-photo-video"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Media Assets</div>
                    <div class="stat-value">@dashboardData.MediaAssetStats.Total.ToString("N0")</div>
                    <div class="stat-detail">@GetMediaAssetChangeText()</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Alerts</div>
                    <div class="stat-value">@dashboardData.AlertStats.Total</div>
                    <div class="stat-detail">@GetAlertStatusText()</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Active Playouts -->
            <div class="panel active-playouts-panel">
                <div class="panel-header">
                    <h2>Active Playouts</h2>
                </div>
                <DxGrid Data="@dashboardData.ActivePlayouts"
                        CssClass="playouts-grid"
                        ShowFilterRow="false"
                        ShowGroupPanel="false"
                        AllowSort ="false"
                        ColumnResizeMode="GridColumnResizeMode.Disabled">
                    <Columns>
                        <DxGridDataColumn FieldName="PlayoutName" Caption="Playout Name" Width="25%" SortIndex="-1" AllowSort="false" />
                        <DxGridDataColumn FieldName="ChannelName" Caption="Channel Name" Width="25%" SortIndex="-1" AllowSort="false" />
                        <DxGridDataColumn FieldName="Status" Caption="Status" Width="20%" SortIndex="-1" AllowSort="false">
                            <CellDisplayTemplate>
                                @{
                                    var playout = (ActivePlayout)context.DataItem;
                                    var statusText = playout.IsOnline == 0 ? "OFFLINE" : playout.IsOnline == 1 ? "ON AIR" : "UNKNOWN";
                                    var statusClass = playout.IsOnline == 0 ? "offline" : playout.IsOnline == 1 ? "onair" : "unknown";
                                }
                                <span class="status-badge status-@statusClass">
                                    @statusText
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="Playing" Caption="Playing" Width="20%" SortIndex="-1" AllowSort="false">
                            <CellDisplayTemplate>
                                @{
                                    var playout = (ActivePlayout)context.DataItem;
                                    var playingText = playout.IsPlaying == 0 ? "Stopped" : "Playing";
                                    var playingClass = playout.IsPlaying == 0 ? "stopped" : "playing";
                                }
                                <span class="playing-badge playing-@playingClass">
                                    <i class="fas fa-play"></i>
                                    @playingText
                                </span>
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                        <DxGridDataColumn FieldName="Spare" Caption="Spare" Width="10%" TextAlignment="GridTextAlignment.Center" SortIndex="-1" AllowSort="false">
                            <CellDisplayTemplate>
                                @{
                                    var playout = (ActivePlayout)context.DataItem;
                                }
                                @if (playout.Spare)
                                {
                                    <i class="fas fa-check spare-check"></i>
                                }
                            </CellDisplayTemplate>
                        </DxGridDataColumn>
                    </Columns>
                </DxGrid>
            </div>

            <!-- Active Users -->
            <div class="panel active-users-panel">
                <div class="panel-header">
                    <h2>Active Users</h2>
                </div>
                <div class="users-list">
                    @if (dashboardData.ActiveUsers.Count == 0)
                    {
                        <div class="no-users-message">No active users</div>
                    }
                    else
                    {
                        @foreach (var user in dashboardData.ActiveUsers)
                        {
                            <div class="user-item">
                                <div class="user-app-icon">
                                    @if (user.Application == "Remote Control")
                                    {
                                        <i class="fas fa-play-circle"></i>
                                    }
                                    else if (user.Application == "Scheduler")
                                    {
                                        <i class="fas fa-calendar-alt"></i>
                                    }
                                    else if (user.Application == "Cg Control")
                                    {
                                        <i class="fas fa-film"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-user"></i>
                                    }
                                </div>
                                <div class="user-info">
                                    <div class="user-name-text">@user.Name</div>
                                    <div class="user-application">@user.Application</div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- System Resources -->
            <div class="panel system-resources-panel">
                <div class="panel-header">
                    <h2>System Resources</h2>
                    <div class="telemetry-toggle">
                        <button class="telemetry-btn @(telemetryEnabled ? "telemetry-on" : "telemetry-off")"
                                @onclick="ToggleTelemetry">
                            Telemetry @(telemetryEnabled ? "ON" : "OFF")
                        </button>
                    </div>
                </div>
                <div class="resources-content">
                    <div class="resource-stats">
                        <div class="resource-item">
                            <div class="resource-label">CPU</div>
                            <div class="resource-value">@dashboardData.SystemResources.CpuUsage%</div>
                        </div>
                        <div class="resource-item">
                            <div class="resource-label">GPU</div>
                            <div class="resource-value">@dashboardData.SystemResources.GpuUsage%</div>
                        </div>
                        <div class="resource-item">
                            <div class="resource-label">RAM</div>
                            <div class="resource-value">@dashboardData.SystemResources.RamUsage%</div>
                        </div>
                    </div>
                    <div class="cpu-chart">
                        <DxChart Data="@dashboardData.SystemResources.CpuHistory"
                                 Width="100%"
                                 Height="200px"
                                 LabelOverlap="ChartLabelOverlap.Hide">
                            <DxChartAreaSeries Name="CPU Usage"
                                               T="CpuDataPoint"
                                               TArgument="DateTime"
                                               TValue="int"
                                               ArgumentField="@(point => point.Time)"
                                               ValueField="@(point => point.Value)"
                                               HoverMode="ChartContinuousSeriesHoverMode.None">
                                <DxChartSeriesPoint Visible="false"
                                                    HoverMode="ChartSeriesPointHoverMode.None" />
                            </DxChartAreaSeries>
                            <DxChartArgumentAxis>
                                <DxChartAxisLabel Format="ChartElementFormat.ShortTime" />
                            </DxChartArgumentAxis>
                            <DxChartValueAxis>
                                <DxChartAxisTitle Text="CPU %" />
                            </DxChartValueAxis>
                            <DxChartLegend Visible="false" />
                            <DxChartTooltip Enabled="true" Position="RelativePosition.Outside">
                                @context.Point.Render((seriesPoint) =>
                                    @<div class="chart-tooltip">
                                        <div>@($"{seriesPoint.Argument:HH:mm:ss}")</div>
                                        <div><strong>@($"{seriesPoint.Value}%")</strong></div>
                                    </div>
                                )
                            </DxChartTooltip>
                        </DxChart>
                    </div>
                </div>
            </div>

            <!-- Error Frequency Chart -->
            <div class="panel error-frequency-panel">
                <div class="panel-header">
                    <h2>Error Frequency (last 7 days)</h2>
                </div>
                <DxChart Data="@errorFrequencyData" Width="100%">
                    <DxChartBarSeries ArgumentField="@((ErrorFrequencyItem v) => v.Day)"
                                      ValueField="@((ErrorFrequencyItem v) => v.Count)"
                                      Name="Errors">
                        <DxChartSeriesPoint HoverMode="ChartSeriesPointHoverMode.Point" />
                    </DxChartBarSeries>
                    <DxChartLegend Visible="false" />
                    <DxChartTooltip Enabled="true" Position="RelativePosition.Outside">
                        <div class="chart-tooltip">
                            <div>@context.Point.Argument</div>
                            <div><strong>@context.Point.Value errors</strong></div>
                        </div>
                    </DxChartTooltip>
                </DxChart>
                <div class="chart-footer">
                    <div class="recommended-actions">
                        <div class="recommended-label">RECOMMENDED ACTIONS</div>
                        <div class="recommended-item">Ffmpeg update required</div>
                    </div>
                </div>
            </div>

            <!-- Errors (previously Alerts) -->
            <div class="panel errors-panel">
                <div class="panel-header-errors">
                    <h2>Errors</h2>
                </div>
                <div class="error-filters-container">
                    <button class="filter-btn active">All</button>
                    <button class="filter-btn">Critical</button>
                    <button class="filter-btn">Warning</button>
                    <button class="filter-btn">Acknowledge</button>
                </div>
                <div class="errors-list">
                    @foreach (var error in dashboardData.Alerts)
                    {
                        <div class="error-item-new error-@error.Type">
                            <div class="error-icon-new"></div>
                            <div class="error-content-new">
                                <div class="error-message-new">@error.Message</div>
                                <div class="error-meta-new">
                                    <span class="error-date">@error.TimeAgo</span>
                                </div>
                            </div>
                            <div class="error-badge">@error.PlayoutName</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>


